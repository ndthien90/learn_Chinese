<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Speaking Practice</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: Arial, sans-serif;
}

body {
    min-height: 100vh;
    background: #f5f5f5;
    padding: 0.5rem;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

h1 {
    text-align: center;
    margin-bottom: 1.5rem;
    color: #333;
    font-size: 1.8rem;
}

.lesson-select {
    margin-bottom: 1.5rem;
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
    background: white;
}

.practice-container {
    margin-bottom: 1.5rem;
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.target-sentence {
    font-size: 1.8rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 5px;
    text-align: center;
}

.pinyin {
    font-size: 1.2rem;
    color: #666;
    margin-bottom: 1rem;
    text-align: center;
}

.btn-container {
    display: flex;
    gap: 1rem;
    margin: 20px;
    flex-wrap: nowrap;
    justify-content: center;
}

button {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    flex: 0 1 auto;
    min-width: 100px;
    max-width: 150px;
    transition: all 0.3s ease;
}

.record {
    background: #4CAF50;
    color: white;
}

.record.recording {
    background: #f44336;
    animation: pulse 1.5s infinite;
}

.next {
    background: #2196F3;
    color: white;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.result-container {
    margin-top: 1.5rem;
}

.your-speech {
    font-size: 1.4rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 5px;
    min-height: 60px;
}

.incorrect {
    background-color: #ffebee;
    color: #c62828;
    padding: 0 3px;
    border-radius: 3px;
}

.score {
    font-size: 1.2rem;
    margin-top: 1rem;
    text-align: center;
    padding: 1rem;
    background: #e3f2fd;
    border-radius: 5px;
    transition: all 0.3s ease;
}

.meaning {
    font-size: 1.1rem;
    color: #666;
    margin-top: 0.5rem;
    text-align: center;
    font-style: italic;
}

.progress-bar {
    width: 100%;
    height: 4px;
    background: #ddd;
    margin-bottom: 1rem;
    border-radius: 2px;
    overflow: hidden;
}

.progress {
    height: 100%;
    background: #4CAF50;
    width: 0;
    transition: width 0.3s ease;
}

.loading {
    text-align: center;
    padding: 1rem;
    color: #666;
    font-style: italic;
}

@media (max-width: 480px) {
    .container {
        padding: 1rem;
    }

    .btn-container {
        flex-direction: row;
        gap: 0.5rem;
        margin: 15px 0;
    }
    
    button {
        padding: 0.75rem 1rem;
        min-width: 80px;
        font-size: 0.9rem;
    }

    .target-sentence {
        font-size: 1.5rem;
        padding: 0.75rem;
    }

    .pinyin {
        font-size: 1.1rem;
    }

    .your-speech {
        font-size: 1.2rem;
        padding: 0.75rem;
    }

    .score {
        font-size: 1.1rem;
        padding: 0.75rem;
    }

    .meaning {
        font-size: 1rem;
    }
}

@media (min-width: 481px) and (max-width: 768px) {
    .container {
        padding: 1.25rem;
    }

    button {
        min-width: 90px;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <h1>Luyện Nói Tiếng Trung</h1>
        
        <select class="lesson-select" id="lessonSelect">
            <option value="">Chọn bài học</option>
            <option value="1">Bài 1 Chào hỏi</option>
            <option value="2">Bài 2 Bản thân</option>
            <option value="3">Bài 3 Gia đình</option>
            <option value="4">Bài 4 Sở thích</option>
            <option value="5">Bài 5 Quê hương</option>
            <option value="6">Bài 6 Sinh nhật</option>
            <option value="7">Bài 7 Thường ngày</option>
        </select>

        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>

        <div class="practice-container">
            <div class="target-sentence" id="target-chinese"></div>
            <div class="pinyin" id="target-pinyin"></div>
            <div class="meaning" id="target-meaning"></div>
        </div>
        <div class="result-container">
            <h3>Câu của bạn:</h3>
            <div class="your-speech" id="speech-result"></div>
            <div class="score" id="score"></div>
        </div>
        <div class="btn-container">
            <button class="record">
                <p>Nói</p>
            </button>
            <button class="next">Tiếp</button>
        </div>
    </div>

    <script>
// Thêm dữ liệu bài học trực tiếp trong JavaScript
const lessonData = {
    1: [
        {
            chinese: "你好很高兴认识你",
            pinyin: "Nǐ hǎo, hěn gāoxìng rènshi nǐ",
            meaning: "Xin chào, rất vui được gặp bạn"
        },
        {
            chinese: "我叫王明今年二十岁",
            pinyin: "Wǒ jiào Wáng Míng, jīnnián èrshí suì",
            meaning: "Tôi tên là Vương Minh, năm nay 20 tuổi"
        },
        {
            chinese: "你会说中文吗",
            pinyin: "Nǐ huì shuō zhōngwén ma",
            meaning: "Bạn có biết nói tiếng Trung không?"
        }
    ],
    2: [
        {
            chinese: "今天天气真好",
            pinyin: "Jīntiān tiānqì zhēn hǎo",
            meaning: "Hôm nay thời tiết thật đẹp"
        },
        {
            chinese: "我想去北京旅游",
            pinyin: "Wǒ xiǎng qù běijīng lǚyóu",
            meaning: "Tôi muốn đi du lịch Bắc Kinh"
        }
    ],
    3: [
        {
            chinese: "这个菜很好吃",
            pinyin: "Zhège cài hěn hǎochī",
            meaning: "Món ăn này rất ngon"
        },
        {
            chinese: "我喜欢学习中文",
            pinyin: "Wǒ xǐhuan xuéxí zhōngwén",
            meaning: "Tôi thích học tiếng Trung"
        }
    ]
};

class LessonManager {
    constructor(lessonData) {
        this.lessonData = lessonData;
        this.sentences = [];
        this.currentSentenceIndex = 0;
    }

    loadLesson(lessonNumber) {
        try {
            this.sentences = this.lessonData[lessonNumber] || [];
            if (this.sentences.length === 0) {
                throw new Error('Không tìm thấy dữ liệu bài học');
            }
            this.currentSentenceIndex = 0;
            return this.getCurrentSentence();
        } catch (error) {
            console.error('Error loading lesson data:', error);
            throw error;
        }
    }

    getCurrentSentence() {
        return this.sentences[this.currentSentenceIndex];
    }

    nextSentence() {
        if (this.sentences.length > 0) {
            this.currentSentenceIndex = (this.currentSentenceIndex + 1) % this.sentences.length;
            return this.getCurrentSentence();
        }
        return null;
    }

    getProgress() {
        return this.sentences.length > 0 
            ? ((this.currentSentenceIndex + 1) / this.sentences.length) * 100 
            : 0;
    }
}

// Class xử lý nhận dạng giọng nói
class SpeechRecognitionHandler {
    constructor(options = {}) {
        this.recognition = null;
        this.recording = false;
        this.speechTimeout = null;
        this.maxSpeechTime = options.maxSpeechTime || 30000;
        this.onResult = options.onResult || (() => {});
        this.onError = options.onError || (() => {});
        this.onStateChange = options.onStateChange || (() => {});
    }

    start() {
        try {
            this.recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            this.recognition.lang = 'zh-CN';
            this.recognition.interimResults = true;
            this.recognition.continuous = true;

            this.recording = true;
            this.onStateChange(true);

            this.recognition.start();
            this.setupTimeoutAndListeners();
        } catch (error) {
            console.error(error);
            this.onError("Trình duyệt không hỗ trợ nhận dạng giọng nói");
        }
    }

    stop() {
        if (this.recognition) {
            this.recognition.stop();
        }
        clearTimeout(this.speechTimeout);
        this.recording = false;
        this.onStateChange(false);
    }

    setupTimeoutAndListeners() {
        this.speechTimeout = setTimeout(() => this.stop(), this.maxSpeechTime);

        this.recognition.onresult = (event) => {
            const results = Array.from(event.results)
                .map(result => result[0].transcript)
                .join('');
            this.onResult(results);
        };

        this.recognition.onend = () => {
            if (this.recording) {
                this.recognition.start();
            } else {
                this.stop();
            }
        };

        this.recognition.onerror = (event) => {
            this.handleError(event);
        };
    }

    handleError(event) {
        clearTimeout(this.speechTimeout);
        this.stop();
        
        const errorMessages = {
            'no-speech': "Không phát hiện được giọng nói. Vui lòng thử lại.",
            'audio-capture': "Không tìm thấy microphone. Hãy đảm bảo microphone được kết nối.",
            'not-allowed': "Vui lòng cho phép truy cập microphone để sử dụng ứng dụng.",
            'network': "Lỗi kết nối mạng. Vui lòng kiểm tra kết nối internet.",
            'aborted': "Đã hủy ghi âm."
        };
        
        this.onError(errorMessages[event.error] || `Đã xảy ra lỗi: ${event.error}`);
    }
}

// Class xử lý text và tính điểm
class TextProcessor {
    static cleanText(text) {
        return text.replace(/[.,?!，。？！\s]/g, '').toLowerCase();
    }

    static segmentChinese(text) {
        return Array.from(text);
    }

    static compareTexts(original, spoken) {
        const cleanOriginal = this.cleanText(original);
        const cleanSpoken = this.cleanText(spoken);

        const originalChars = this.segmentChinese(cleanOriginal);
        const spokenChars = this.segmentChinese(cleanSpoken);

        let result = '';
        let correctCount = 0;
        
        const maxLength = Math.max(originalChars.length, spokenChars.length);
        
        for (let i = 0; i < maxLength; i++) {
            if (i < spokenChars.length) {
                if (i < originalChars.length && spokenChars[i] === originalChars[i]) {
                    result += spokenChars[i];
                    correctCount++;
                } else {
                    result += `<span class="incorrect">${spokenChars[i]}</span>`;
                }
            }
        }

        const score = Math.round((correctCount / originalChars.length) * 100);
        return { result, score };
    }
}

// Class chính quản lý ứng dụng
class App {
    constructor() {
        this.initializeElements();
        this.lessonManager = new LessonManager(lessonData);
        this.setupSpeechRecognition();
        this.bindEvents();
        this.initialize();
    }

    initializeElements() {
        this.elements = {
            recordBtn: document.querySelector(".record"),
            nextBtn: document.querySelector(".next"),
            targetChinese: document.getElementById("target-chinese"),
            targetPinyin: document.getElementById("target-pinyin"),
            targetMeaning: document.getElementById("target-meaning"),
            speechResult: document.getElementById("speech-result"),
            scoreDisplay: document.getElementById("score"),
            progressBar: document.getElementById("progress"),
            lessonSelect: document.getElementById("lessonSelect")
        };
    }

    setupSpeechRecognition() {
        this.speechHandler = new SpeechRecognitionHandler({
            onResult: (results) => this.handleSpeechResult(results),
            onError: (message) => alert(message),
            onStateChange: (isRecording) => this.updateRecordButtonState(isRecording)
        });
    }

    bindEvents() {
        this.elements.recordBtn.addEventListener("click", () => this.toggleRecording());
        this.elements.nextBtn.addEventListener("click", () => this.nextSentence());
        this.elements.lessonSelect.addEventListener('change', (e) => this.handleLessonChange(e));
    }

    initialize() {
        this.updateDisplay("Vui lòng chọn bài học", "", "");
        this.updateProgress(0);
    }

    handleLessonChange(event) {
        if (event.target.value) {
            this.clearAndReset();
            try {
                const sentence = this.lessonManager.loadLesson(parseInt(event.target.value));
                this.updateDisplayWithSentence(sentence);
                this.updateProgress(this.lessonManager.getProgress());
            } catch (error) {
                alert('Không thể tải dữ liệu bài học. Vui lòng thử lại sau.');
            }
        } else {
            this.clearAndReset();
            this.initialize();
        }
    }

    toggleRecording() {
        if (!this.speechHandler.recording) {
            if (this.lessonManager.sentences.length === 0) {
                alert("Vui lòng chọn bài học trước khi bắt đầu.");
                return;
            }
            this.speechHandler.start();
        } else {
            this.speechHandler.stop();
        }
    }

    handleSpeechResult(results) {
        const currentSentence = this.lessonManager.getCurrentSentence();
        const comparison = TextProcessor.compareTexts(currentSentence.chinese, results);
        this.elements.speechResult.innerHTML = comparison.result;
        this.elements.scoreDisplay.innerHTML = `Điểm số: ${comparison.score}/100`;
    }

    nextSentence() {
        if (this.lessonManager.sentences.length > 0) {
            const sentence = this.lessonManager.nextSentence();
            this.clearAndReset();
            this.updateDisplayWithSentence(sentence);
            this.updateProgress(this.lessonManager.getProgress());
        } else {
            alert("Vui lòng chọn bài học trước khi chuyển câu.");
        }
    }

    updateDisplayWithSentence(sentence) {
        if (sentence) {
            this.updateDisplay(sentence.chinese, sentence.pinyin, sentence.meaning);
        }
    }

    updateDisplay(chinese, pinyin, meaning) {
        this.elements.targetChinese.textContent = chinese;
        this.elements.targetPinyin.textContent = pinyin;
        this.elements.targetMeaning.textContent = meaning;
    }

    updateProgress(progress) {
        this.elements.progressBar.style.width = `${progress}%`;
    }

    updateRecordButtonState(isRecording) {
        const btn = this.elements.recordBtn;
        if (isRecording) {
            btn.classList.add("recording");
            btn.querySelector("p").innerHTML = "Đang nghe...";
        } else {
            btn.classList.remove("recording");
            btn.querySelector("p").innerHTML = "Bắt đầu nói";
        }
    }

    clearAndReset() {
        if (this.speechHandler.recording) {
            this.speechHandler.stop();
        }
        this.elements.speechResult.innerHTML = "";
        this.elements.scoreDisplay.innerHTML = "";
        this.updateRecordButtonState(false);
    }
}

// Khởi tạo ứng dụng khi trang đã tải xong
document.addEventListener('DOMContentLoaded', () => {
    const app = new App();
});

    </script>
</body>
</html>
